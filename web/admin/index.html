<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Mapping Verification Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        
        header {
            background: white;
            border-bottom: 1px solid #e5e5e7;
            padding: 1rem 2rem;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6e6e73;
            position: relative;
        }
        
        .tab.active {
            color: #1d1d1f;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #007AFF;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e5e7;
        }
        
        th {
            font-weight: 600;
            color: #6e6e73;
            font-size: 0.875rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge.symbol {
            background: #FFF3CD;
            color: #856404;
        }
        
        .badge.slug {
            background: #D4EDDA;
            color: #155724;
        }
        
        .badge.manual {
            background: #D1ECF1;
            color: #0C5460;
        }
        
        .badge.outlier {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .confidence {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .confidence.high { background: #D4EDDA; color: #155724; }
        .confidence.medium { background: #FFF3CD; color: #856404; }
        .confidence.low { background: #F8D7DA; color: #721C24; }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        .btn-verify {
            background: #34C759;
            color: white;
        }
        
        .btn-flag {
            background: #FF3B30;
            color: white;
        }
        
        .btn-resolve {
            background: #007AFF;
            color: white;
        }
        
        .deviation {
            font-weight: 600;
        }
        
        .deviation.high { color: #FF3B30; }
        .deviation.medium { color: #FF9500; }
        .deviation.low { color: #34C759; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6e6e73;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6e6e73;
        }
    </style>
</head>
<body>
    <header>
        <h1>Token Mapping Verification Dashboard</h1>
    </header>
    
    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="unverifiedCount">-</div>
                <div class="stat-label">Unverified Mappings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="outlierCount">-</div>
                <div class="stat-label">Active Outliers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="symbolMappingCount">-</div>
                <div class="stat-label">Symbol-based Mappings</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('mappings')">Unverified Mappings</button>
            <button class="tab" onclick="showTab('outliers')">Price Outliers</button>
        </div>
        
        <div id="mappingsTab" class="tab-content">
            <div class="card">
                <table id="mappingsTable">
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>Exchange Symbol</th>
                            <th>Mapped To</th>
                            <th>Method</th>
                            <th>Confidence</th>
                            <th>Has Outliers</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mappingsBody">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="outliersTab" class="tab-content" style="display: none;">
            <div class="card">
                <table id="outliersTable">
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>Pair</th>
                            <th>Exchange Price</th>
                            <th>Average Price</th>
                            <th>Deviation</th>
                            <th>Std Dev</th>
                            <th>Mapping Method</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="outliersBody">
                        <tr><td colspan="8" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1/admin';
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadMappings();
            loadOutliers();
            updateStats();
        });
        
        function showTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            if (tab === 'mappings') {
                document.getElementById('mappingsTab').style.display = 'block';
                document.getElementById('outliersTab').style.display = 'none';
            } else {
                document.getElementById('mappingsTab').style.display = 'none';
                document.getElementById('outliersTab').style.display = 'block';
            }
        }
        
        async function loadMappings() {
            try {
                const response = await fetch(`${API_BASE}/mappings/unverified`);
                const data = await response.json();
                
                const tbody = document.getElementById('mappingsBody');
                
                if (data.mappings && data.mappings.length > 0) {
                    tbody.innerHTML = data.mappings.map(m => `
                        <tr>
                            <td>${m.exchange_id}</td>
                            <td><code>${m.exchange_symbol}</code></td>
                            <td><strong>${m.token_symbol}</strong> - ${m.token_name}</td>
                            <td><span class="badge ${m.mapping_method}">${m.mapping_method}</span></td>
                            <td>
                                <span class="confidence ${getConfidenceClass(m.confidence_score)}">
                                    ${(m.confidence_score * 100).toFixed(0)}%
                                </span>
                            </td>
                            <td>${m.has_outliers ? '<span class="badge outlier">Yes</span>' : 'No'}</td>
                            <td class="actions">
                                <button class="btn-verify" onclick="verifyMapping(${m.id})">Verify</button>
                                <button class="btn-flag" onclick="flagMapping(${m.id})">Flag</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No unverified mappings</td></tr>';
                }
                
                document.getElementById('unverifiedCount').textContent = data.total || 0;
                document.getElementById('symbolMappingCount').textContent = 
                    data.mappings ? data.mappings.filter(m => m.mapping_method === 'symbol').length : 0;
            } catch (error) {
                console.error('Failed to load mappings:', error);
            }
        }
        
        async function loadOutliers() {
            try {
                const response = await fetch(`${API_BASE}/outliers`);
                const data = await response.json();
                
                const tbody = document.getElementById('outliersBody');
                
                if (data.outliers && data.outliers.length > 0) {
                    tbody.innerHTML = data.outliers.map(o => `
                        <tr>
                            <td>${o.ExchangeID}</td>
                            <td>${o.base_token_symbol}/${o.quote_token_symbol}</td>
                            <td>$${parseFloat(o.ExchangePrice).toFixed(2)}</td>
                            <td>$${parseFloat(o.AveragePrice).toFixed(2)}</td>
                            <td class="deviation ${getDeviationClass(o.DeviationPercent)}">
                                ${o.DeviationPercent.toFixed(2)}%
                            </td>
                            <td>${o.StdDeviations.toFixed(2)}σ</td>
                            <td><span class="badge ${o.MappingMethod}">${o.MappingMethod}</span></td>
                            <td class="actions">
                                <button class="btn-resolve" onclick="resolveOutlier(${o.id})">Resolve</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No active outliers</td></tr>';
                }
                
                document.getElementById('outlierCount').textContent = data.total || 0;
            } catch (error) {
                console.error('Failed to load outliers:', error);
            }
        }
        
        async function updateStats() {
            // Stats are updated by loadMappings and loadOutliers
        }
        
        function getConfidenceClass(score) {
            if (score >= 0.8) return 'high';
            if (score >= 0.5) return 'medium';
            return 'low';
        }
        
        function getDeviationClass(deviation) {
            if (deviation > 10) return 'high';
            if (deviation > 5) return 'medium';
            return 'low';
        }
        
        async function verifyMapping(id) {
            const verifiedBy = prompt('Your name:');
            if (!verifiedBy) return;
            
            try {
                await fetch(`${API_BASE}/mappings/${id}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verified_by: verifiedBy })
                });
                loadMappings();
            } catch (error) {
                alert('Failed to verify mapping');
            }
        }
        
        async function flagMapping(id) {
            const flaggedBy = prompt('Your name:');
            if (!flaggedBy) return;
            
            const reason = prompt('Reason for flagging:');
            if (!reason) return;
            
            try {
                await fetch(`${API_BASE}/mappings/${id}/flag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        flagged_by: flaggedBy,
                        reason: reason
                    })
                });
                loadMappings();
            } catch (error) {
                alert('Failed to flag mapping');
            }
        }
        
        async function resolveOutlier(id) {
            const resolvedBy = prompt('Your name:');
            if (!resolvedBy) return;
            
            const notes = prompt('Resolution notes:');
            if (!notes) return;
            
            try {
                await fetch(`${API_BASE}/outliers/${id}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        resolved_by: resolvedBy,
                        notes: notes
                    })
                });
                loadOutliers();
            } catch (error) {
                alert('Failed to resolve outlier');
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadMappings();
            loadOutliers();
        }, 30000);
    </script>
</body>
</html>